<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FrostPH Risk Map (Benguet)</title>

  <!-- CesiumJS -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.116/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.116/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }

    .panel {
      position:absolute; top:12px; left:12px; z-index:999;
      background:rgba(255,255,255,0.95); padding:10px 12px; border-radius:10px;
      font-family:Arial,sans-serif; font-size:13px; box-shadow:0 4px 14px rgba(0,0,0,0.25);
      min-width:270px;
    }
    .row { margin-top:8px; }
    input[type="range"] { width:230px; }

    .legend { margin-top:10px; line-height:1.6; }
    .swatch { display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:6px; vertical-align:middle; }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>

  <div class="panel">
    <b>FrostPH Risk Map</b><br>
    Benguet Province

    <div class="row">
      <b>Risk overlay opacity</b><br>
      <input id="riskSlider" type="range" min="0" max="100" value="80">
      <div>Opacity: <span id="riskValue">80%</span></div>
    </div>

    <div class="legend">
      <b>Legend</b><br>
      <span class="swatch" style="background:#e0e0e0"></span>None<br>
      <span class="swatch" style="background:#66bb6a"></span>Mild<br>
      <span class="swatch" style="background:#f9a825"></span>Moderate<br>
      <span class="swatch" style="background:#1565c0"></span>Severe
    </div>
  </div>

  <script>
    // =========================
    // 1) CESIUM ION TOKEN
    // =========================
    Cesium.Ion.defaultAccessToken = "PASTE_YOUR_TOKEN_HERE";

    // =========================
    // 2) CREATE VIEWER
    // =========================
    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false,
      timeline: false,
      baseLayerPicker: true,
      sceneModePicker: true,
      geocoder: true,
      homeButton: true
    });

    // Start near Benguet
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(120.7, 16.6, 120000)
    });

    // =========================
    // 3) COLOR MAPPING (Hazard_W)
    // None / Mild / Moderate / Severe
    // =========================
    function riskColor(level) {
      if (level === "Severe")   return Cesium.Color.fromCssColorString("#1565c0"); // blue
      if (level === "Moderate") return Cesium.Color.fromCssColorString("#f9a825"); // yellow
      if (level === "Mild")     return Cesium.Color.fromCssColorString("#66bb6a"); // light green
      return Cesium.Color.fromCssColorString("#e0e0e0"); // None = gray
    }

    // =========================
    // 4) LOAD RISK LAYER
    // Asset ID: 4430889
    // =========================
    async function loadRiskLayer() {
      const ds = await Cesium.GeoJsonDataSource.load(
        Cesium.IonResource.fromAssetId(4430889),
        { clampToGround: true }
      );
      viewer.dataSources.add(ds);

      const entities = ds.entities.values;
      const baseColors = new Map();

      for (const e of entities) {
        if (!e.polygon) continue;

        // ✅ Your risk field name
        const level = e.properties?.Hazard_W?.getValue?.() ?? "None";
        const base = riskColor(level);
        baseColors.set(e.id, base);

        e.polygon.outline = true;
        e.polygon.outlineColor = Cesium.Color.WHITE.withAlpha(0.6);

        const name =
          e.properties?.ADM4_EN?.getValue?.() ??
          e.properties?.ADM3_EN?.getValue?.() ??
          e.properties?.name?.getValue?.() ??
          "Area";

        e.description = `
          <b>${name}</b><br>
          <b>Hazard:</b> ${level}
        `;
      }

      // Slider controls opacity (0 = off, 1 = on)
      const slider = document.getElementById("riskSlider");
      const valueLabel = document.getElementById("riskValue");

      function applyOpacity(opacity) {
        for (const e of entities) {
          if (!e.polygon) continue;
          e.polygon.material = baseColors.get(e.id).withAlpha(opacity);
        }
      }

      applyOpacity(Number(slider.value) / 100);

      slider.addEventListener("input", () => {
        const pct = Number(slider.value);
        valueLabel.textContent = pct + "%";
        applyOpacity(pct / 100);
      });

      return ds;
    }

    // =========================
    // 5) MASK OUTSIDE BENGUET
    // Municipality boundary asset: 4076193
    // =========================
    async function addBenguetMask() {
      const boundaryDS = await Cesium.GeoJsonDataSource.load(
        Cesium.IonResource.fromAssetId(4076193),
        { clampToGround: true }
      );
      viewer.dataSources.add(boundaryDS);

      // Collect all municipality polygons (in case the file contains multiple features)
      const polys = boundaryDS.entities.values.filter(e => e.polygon && e.polygon.hierarchy);

      if (!polys.length) {
        console.error("No polygon found in Benguet Municipality asset 4076193.");
        return;
      }

      const now = Cesium.JulianDate.now();

      // ✅ Clean rectangle polygon (not RectangleGeometry)
      const west = 114, south = 5, east = 130, north = 22;
      const rectPositions = Cesium.Cartesian3.fromDegreesArray([
        west, south,
        east, south,
        east, north,
        west, north
      ]);

      // Each municipality polygon becomes a hole so Benguet stays visible
      const holes = polys.map(e => {
        const h = e.polygon.hierarchy.getValue(now);
        return new Cesium.PolygonHierarchy(h.positions);
      });

      // Mask polygon: big rectangle with holes = Benguet area visible
      viewer.entities.add({
        name: "Outside Benguet Mask",
        polygon: {
          hierarchy: new Cesium.PolygonHierarchy(rectPositions, holes),
          material: Cesium.Color.BLACK.withAlpha(0.78), // outside opacity strength
          outline: false,
          perPositionHeight: false,
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
          classificationType: Cesium.ClassificationType.BOTH
        }
      });

      // Hide boundary visuals; keep only mask effect
      for (const e of boundaryDS.entities.values) {
        if (e.polygon) e.polygon.material = Cesium.Color.TRANSPARENT;
        if (e.polyline) e.polyline.show = false;
      }
    }

    // =========================
    // 6) RUN
    // =========================
    (async () => {
      const riskDS = await loadRiskLayer();
      await addBenguetMask();
      viewer.flyTo(riskDS);
    })();
  </script>
</body>
</html>
