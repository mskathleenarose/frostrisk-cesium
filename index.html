<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FrostPH 3D Risk Map</title>

<script src="https://cesium.com/downloads/cesiumjs/releases/1.116/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.116/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

<style>
html, body, #cesiumContainer {
  width:100%; height:100%;
  margin:0; padding:0;
  overflow:hidden;
}

/* ================= PANEL ================= */
.panel{
  position:absolute;
  top:12px;
  left:12px;
  z-index:999;
  background:rgba(255,255,255,0.96);
  padding:12px;
  border-radius:12px;
  font-family:Arial,sans-serif;
  font-size:13px;
  box-shadow:0 6px 18px rgba(0,0,0,0.25);
  min-width:290px;
  transition:all 0.25s ease;
}

.panel.collapsed #panelContent{
  display:none;
}

.row{ margin-top:10px; }
input[type="range"]{ width:240px; }
.legend{ margin-top:10px; line-height:1.6; }
.swatch{
  display:inline-block;
  width:12px;
  height:12px;
  border-radius:3px;
  margin-right:6px;
  vertical-align:middle;
}
.small{ color:#444; font-size:12px; }

/* ================= POPUP ================= */
.cesium-infoBox{
  border-radius:14px !important;
  box-shadow:0 10px 26px rgba(0,0,0,0.28) !important;
}
.cesium-infoBox-title{
  font-weight:900 !important;
  font-size:14px !important;
}
</style>
</head>

<body>

<div id="cesiumContainer"></div>

<!-- ================= CONTROL PANEL ================= -->
<div class="panel" id="controlPanel">

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <b>FrostPH Risk Map (3D)</b><br>
      <span class="small">GeoJSON overlay • 3D terrain</span>
    </div>
    <button id="toggleBtn" style="
      border:none;
      background:#0b4a8b;
      color:white;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;">
      Hide
    </button>
  </div>

  <div id="panelContent">

    <div class="row">
      <b>Risk overlay opacity</b><br>
      <input id="riskSlider" type="range" min="0" max="100" value="65">
      <div>Opacity: <span id="riskValue">65%</span></div>
    </div>

    <div class="row">
      <b>Terrain exaggeration</b><br>
      <input id="exagSlider" type="range" min="100" max="250" value="160">
      <div>Exaggeration: <span id="exagValue">1.60×</span></div>
    </div>

    <div class="legend">
      <b>Legend</b><br>
      <span class="swatch" style="background:#e0e0e0"></span>None<br>
      <span class="swatch" style="background:#2e7d32"></span>Mild<br>
      <span class="swatch" style="background:#f9a825"></span>Moderate<br>
      <span class="swatch" style="background:#1565c0"></span>Severe
    </div>

    <div class="small" style="margin-top:10px;">
      Drag to rotate • Right-drag to pan • Scroll to zoom • Tilt in 3D
    </div>

  </div>
</div>

<script>

// ================= CONFIG =================
const RISK_ASSET_ID = 4431024;
const BOUNDARY_ASSET_ID = 4076193;
const RISK_FIELD = "RiskCls";

Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1NjIyMmEzMy01NmJkLTQwYTQtYjM5MS02NTA4ZmNjMGI1MTAiLCJpZCI6MzU5OTE1LCJpYXQiOjE3NjMwMDg3NTl9.BD0gTbvODVhDqjfV-i31W0UitaC2WHbdA33zsJuzSzg";

// ================= VIEWER =================
const viewer = new Cesium.Viewer("cesiumContainer",{
  terrain: Cesium.Terrain.fromWorldTerrain(),
  animation:false,
  timeline:false,
  baseLayerPicker:true,
  sceneModePicker:true,
  geocoder:true,
  homeButton:true
});

viewer.scene.mode = Cesium.SceneMode.SCENE3D;
viewer.scene.globe.depthTestAgainstTerrain = false;
viewer.scene.globe.enableLighting = true;
viewer.shadows = true;
viewer.scene.globe.terrainExaggeration = 1.6;

viewer.camera.setView({
  destination: Cesium.Cartesian3.fromDegrees(120.7,16.6,65000),
  orientation:{
    heading:Cesium.Math.toRadians(20),
    pitch:Cesium.Math.toRadians(-45),
    roll:0
  }
});

// ================= HELPERS =================
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function riskColor(v){
  const raw=(v??"").toString().trim().toLowerCase();
  if(raw==="3"||raw==="severe") return "#1565c0";
  if(raw==="2"||raw==="moderate") return "#f9a825";
  if(raw==="1"||raw==="mild") return "#2e7d32";
  return "#e0e0e0";
}

function riskLabel(v){
  const raw=(v??"").toString().trim();
  if(raw==="3") return "Severe";
  if(raw==="2") return "Moderate";
  if(raw==="1") return "Mild";
  return raw || "None";
}

// ================= LOAD BOUNDARY =================
async function loadBoundary(){
  const res=await Cesium.IonResource.fromAssetId(BOUNDARY_ASSET_ID);
  const ds=await Cesium.GeoJsonDataSource.load(res,{clampToGround:true});
  viewer.dataSources.add(ds);

  const now=Cesium.JulianDate.now();

  for(const e of ds.entities.values){
    if(!e.polygon) continue;
    e.polygon.material=Cesium.Color.TRANSPARENT;
    e.polygon.outline=false;

    const h=e.polygon.hierarchy.getValue(now);
    if(!h?.positions) continue;

    viewer.entities.add({
      polyline:{
        positions:h.positions,
        clampToGround:true,
        width:2,
        material:Cesium.Color.WHITE.withAlpha(0.85)
      }
    });

    e.name="";
    e.description="";
  }
}

// ================= LOAD RISK =================
async function loadRisk(){
  const res=await Cesium.IonResource.fromAssetId(RISK_ASSET_ID);
  const ds=await Cesium.GeoJsonDataSource.load(res,{clampToGround:true});
  viewer.dataSources.add(ds);

  const now=Cesium.JulianDate.now();

  for(const e of ds.entities.values){
    if(!e.polygon) continue;

    const risk=e.properties?.[RISK_FIELD]?.getValue?.(now) ?? "None";
    const color=Cesium.Color.fromCssColorString(riskColor(risk));

    e._baseColor=color;

    e.polygon.height=undefined;
    e.polygon.extrudedHeight=undefined;
    e.polygon.perPositionHeight=false;
    e.polygon.material=new Cesium.ColorMaterialProperty(color.withAlpha(0.65));
    e.polygon.outline=false;

    const barangay=e.properties?.ADM4_EN?.getValue?.(now) ?? "Unknown barangay";
    const muni=e.properties?.ADM3_EN?.getValue?.(now) ?? "Unknown municipality";

    e.name=`${barangay}, ${muni}`;

    e.description=`
      <div style="font-family:Arial; font-size:13px;">
        <div style="font-size:16px; font-weight:900;">${escapeHtml(barangay)}</div>
        <div style="color:#555; margin-bottom:10px;">
          Municipality: <b>${escapeHtml(muni)}</b>
        </div>
        <div style="padding:10px; border:1px solid #eee; border-radius:10px; background:#fafafa;">
          <div style="font-weight:800; font-size:12px;">RISKCLS</div>
          <div style="margin-top:6px; font-weight:900; color:${riskColor(risk)};">
            ${riskLabel(risk)}
          </div>
        </div>
      </div>`;
  }

  return ds;
}

// ================= UI =================
function wireUI(ds){
  const slider=document.getElementById("riskSlider");
  const val=document.getElementById("riskValue");

  function applyOpacity(a){
    for(const e of ds.entities.values){
      if(!e.polygon) continue;
      e.polygon.material=new Cesium.ColorMaterialProperty(
        e._baseColor.withAlpha(a)
      );
    }
  }

  applyOpacity(slider.value/100);

  slider.addEventListener("input",()=>{
    val.textContent=slider.value+"%";
    applyOpacity(slider.value/100);
  });

  const exag=document.getElementById("exagSlider");
  const exagVal=document.getElementById("exagValue");

  exag.addEventListener("input",()=>{
    const v=exag.value/100;
    exagVal.textContent=v.toFixed(2)+"×";
    viewer.scene.globe.terrainExaggeration=v;
  });
}

// ================= PANEL TOGGLE =================
document.getElementById("toggleBtn").addEventListener("click",()=>{
  const panel=document.getElementById("controlPanel");
  panel.classList.toggle("collapsed");
  document.getElementById("toggleBtn").textContent=
    panel.classList.contains("collapsed") ? "Show" : "Hide";
});

// ================= RUN =================
(async()=>{
  await loadBoundary();
  const riskDS=await loadRisk();
  wireUI(riskDS);
})();
</script>

</body>
</html>
