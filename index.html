<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FrostPH Risk Map (OSM basemap)</title>

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.116/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.116/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
    .panel {
      position:absolute; top:12px; left:12px; z-index:999;
      background:rgba(255,255,255,0.95); padding:10px 12px; border-radius:10px;
      font-family:Arial,sans-serif; font-size:13px; box-shadow:0 4px 14px rgba(0,0,0,0.25);
      min-width:270px;
    }
    .row { margin-top:8px; }
    input[type="range"] { width:230px; }
    .legend { margin-top:10px; line-height:1.6; }
    .swatch { display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:6px; vertical-align:middle; }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>

  <div class="panel">
    <b>FrostPH Risk Map</b><br>
    (OSM basemap • Asset 4431024)

    <div class="row">
      <b>Risk overlay opacity</b><br>
      <input id="riskSlider" type="range" min="0" max="100" value="80">
      <div>Opacity: <span id="riskValue">80%</span></div>
    </div>

    <div class="legend">
      <b>Legend</b><br>
      <span class="swatch" style="background:#e0e0e0"></span>None<br>
      <span class="swatch" style="background:#2e7d32"></span>Mild<br>
      <span class="swatch" style="background:#f9a825"></span>Moderate<br>
      <span class="swatch" style="background:#1565c0"></span>Severe
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const RISK_ASSET_ID = 4431024;     // FrostRiskPrelim geojson
    const RISK_FIELD = "RiskCls";      // <-- change if your column differs

    // Start near Benguet (just a start view; no lock yet)
    const START_RECT = Cesium.Rectangle.fromDegrees(120.05, 15.75, 121.65, 17.45);

    // =========================
    // TOKEN (PASTE YOUR NEW TOKEN HERE — DO NOT SHARE IT)
    // =========================
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmNDNkZTM0OS00YjJjLTQ1NGYtODY3OC04NGJkNTMyNTVjMzciLCJpZCI6MzU5OTE1LCJpYXQiOjE3NzA2MTk2NTR9.7AMr5xm4NqjOYC-WuCZv1OHw-JwpQsQaXCOl01SE0_0";

    // =========================
    // VIEWER (OSM basemap so it won't be black)
    // =========================
    const viewer = new Cesium.Viewer("cesiumContainer", {
      imageryProvider: new Cesium.OpenStreetMapImageryProvider({
        url: "https://a.tile.openstreetmap.org/"
      }),
      baseLayerPicker: false,
      terrainProvider: new Cesium.EllipsoidTerrainProvider(), // flat earth
      animation: false,
      timeline: false,
      sceneModePicker: true,
      geocoder: false,
      homeButton: true
    });

    viewer.camera.setView({ destination: START_RECT });
    viewer.homeButton.viewModel.command.beforeExecute.addEventListener((e) => {
      e.cancel = true;
      viewer.camera.flyTo({ destination: START_RECT });
    });

    // =========================
    // COLORS
    // =========================
    function norm(v) { return (v ?? "").toString().trim().toLowerCase(); }

    function riskColor(levelRaw) {
      const level = norm(levelRaw);
      if (level === "severe")   return Cesium.Color.fromCssColorString("#1565c0"); // blue
      if (level === "moderate") return Cesium.Color.fromCssColorString("#f9a825"); // yellow
      if (level === "mild")     return Cesium.Color.fromCssColorString("#2e7d32"); // green
      return Cesium.Color.fromCssColorString("#e0e0e0"); // none/unknown
    }

    // =========================
    // LOAD RISK LAYER
    // =========================
    (async () => {
      let ds;
      try {
        ds = await Cesium.GeoJsonDataSource.load(
          Cesium.IonResource.fromAssetId(RISK_ASSET_ID),
          { clampToGround: true }
        );
      } catch (err) {
        console.error("Failed loading risk asset:", err);
        alert("Risk asset failed to load. Open Console (F12) and check errors.");
        return;
      }

      viewer.dataSources.add(ds);

      const entities = ds.entities.values;
      const baseColors = new Map();

      for (const e of entities) {
        if (!e.polygon) continue;

        const level = e.properties?.[RISK_FIELD]?.getValue?.() ?? "None";
        const base = riskColor(level);
        baseColors.set(e.id, base);

        e.polygon.outline = true;
        e.polygon.outlineColor = Cesium.Color.BLACK.withAlpha(0.35);

        const name =
          e.properties?.ADM4_EN?.getValue?.() ??
          e.properties?.ADM3_EN?.getValue?.() ??
          e.properties?.name?.getValue?.() ??
          "Area";

        e.description = `<b>${name}</b><br><b>Risk:</b> ${level}`;
      }

      // Slider
      const slider = document.getElementById("riskSlider");
      const valueLabel = document.getElementById("riskValue");

      function applyOpacity(opacity) {
        for (const e of entities) {
          if (!e.polygon) continue;
          e.polygon.material = baseColors.get(e.id).withAlpha(opacity);
        }
      }

      applyOpacity(Number(slider.value) / 100);

      slider.addEventListener("input", () => {
        const pct = Number(slider.value);
        valueLabel.textContent = pct + "%";
        applyOpacity(pct / 100);
      });

      await viewer.flyTo(ds);
    })();
  </script>
</body>
</html>
